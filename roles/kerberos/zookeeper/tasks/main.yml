---
- import_role:
    name: tosit.tdp.kerberos.common

- import_role:
    name: tosit.tdp.zookeeper.server
    vars_from: defaults/main.yml

- name: Ensures /etc/security/keytabs exists
  file:
    path: "/etc/security/keytabs"
    state: directory

- name: Generate principals and keytabs
  shell: |
    kadmin -r {{ realm }} -p {{ kadmin_principal }} -w {{ kadmin_password }} -q "addprinc -randkey zookeeper/{{ ansible_fqdn }}"
    kadmin -r {{ realm }} -p {{ kadmin_principal }} -w {{ kadmin_password }} -q "xst -k zookeeper.service.keytab zookeeper/{{ ansible_fqdn }}@{{ realm }}"
    chown {{ zookeeper_user }}:{{ hadoop_group }} zookeeper.service.keytab
  args:
    chdir: /etc/security/keytabs
    creates: /etc/security/keytabs/zookeeper.service.keytab

- name: Template jaas.conf
  template:
    src: jaas.conf.j2
    dest: "{{ zookeeper_install_dir }}/conf/jaas.conf"
