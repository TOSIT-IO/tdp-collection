# Copyright 2022 TOSIT.IO
# SPDX-License-Identifier: Apache-2.0

---
# Should TDP manage firewall rules on cluster nodes
firewall_tdp_managed: no
# Only takes effect if 'firewall_tdp_managed: yes'
firewall_start_on_boot: no
# For now only 'firewalld' is supported
firewall_service: firewalld

firewalld_files_prefix: tdp_

# 'groups' and/or 'addresses' has to be != [] in order for the zone to take effect
# One source can only be used in one zone
firewalld_zones:
  - name: public
    short: TDP cluster public zone
    groups: []
    addresses:
      - 0.0.0.0/1
      - 128.0.0.0/1
  - name: internal
    short: TDP cluster internal zone
    groups:
      - tdp_cluster
    addresses: []

firewalld_rules:
  # Kerberos/LDAP
  kdc:
    - name: kerberos_kdc_tcp
      short: Kerberos KDC TCP port
      port: "{{ kerberos_kdc_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: kerberos_kdc_udp
      short: Kerberos KDC UDP port
      port: "{{ kerberos_kdc_port }}"
      protocol: udp
      zones:
        - internal
        - public
      state: present
    - name: kerberos_admin_tdp
      short: Kerberos Admin TCP port
      port: "{{ kerberos_admin_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: kerberos_admin_udp
      short: Kerberos Admin UDP port
      port: "{{ kerberos_admin_port }}"
      protocol: udp
      zones:
        - internal
        - public
      state: present
  kdcproxy:
    - name: kerberos_kdcproxy
      short: Kerberos KDC Proxy port
      port: "{{ kerberos_kdcproxy_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
  ldap:
    - name: openldap_server_ldap
      short: OpenLDAP LDAP port
      port: "{{ openldap_server_ldap_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: openldap_server_ldaps
      short: OpenLDAP LDAPS port
      port: "{{ openldap_server_ldaps_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present

  # PostgreSQL
  postgresql:
    - name: postgresql_server
      short: PostgreSQL port
      port: "{{ postgresql_server_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present

  # Ranger
  ranger_solr:
    - name: ranger_solr_http_port
      short: Ranger Solr HTTP port
      port: "{{ ranger_solr_http_port }}"
      protocol: tcp
      zones:
        - internal
      state: present
  ranger_admin:
    - name: ranger_adm_https_port
      short: Ranger Admin HTTPS port
      port: "{{ ranger_adm_https_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_ranger_ra_http_port
      short: Ranger Admin Prometheus exporter HTTP port
      port: "{{ exporter_ranger_ra_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
  ranger_usersync:
    - name: ranger_usersync_https_port
      short: Ranger Usersync HTTPS port
      port: "{{ ranger_usersync_https_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_ranger_ru_http_port
      short: Ranger Usersync Prometheus exporter HTTP port
      port: "{{ exporter_ranger_ru_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
  ranger_kms:
    - name: ranger_kms_https_port
      short: Ranger KMS HTTPS port
      port: "{{ ranger_kms_https_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_ranger_kms_http_port
      short: Ranger KMS Prometheus exporter HTTP port
      port: "{{ exporter_ranger_kms_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present

  # ZooKeeper
  zk:
    - name: zookeeper_server_quorum_port
      short: ZooKeeper Server quorum port
      port: "{{ zookeeper_server_quorum_port }}"
      protocol: tcp
      zones:
        - internal
      state: present
    - name: zookeeper_server_election_port
      short: ZooKeeper Server election port
      port: "{{ zookeeper_server_election_port }}"
      protocol: tcp
      zones:
        - internal
      state: present
    - name: zookeeper_server_client_port
      short: ZooKeeper Server client port
      port: "{{ zookeeper_server_client_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_zookeeper_server_http_port
      short: ZooKeeper Server Prometheus exporter HTTP port
      port: "{{ exporter_zookeeper_server_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present

  # HDFS
  hdfs_nn:
    - name: hdfs_zkfc_rpc_port
      short: HDFS ZooKeeper Failover Controller RPC port
      port: "{{ hdfs_zkfc_rpc_port }}"
      protocol: tcp
      zones:
        - internal
      state: present
    - name: hdfs_nn_rpc_port
      short: HDFS NameNode RPC port
      port: "{{ hdfs_nn_rpc_port }}"
      protocol: tcp
      zones:
        - internal
      state: present
    - name: hdfs_nn_https_port
      short: HDFS NameNode HTTPS port
      port: "{{ hdfs_nn_https_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_hdfs_nn_http_port
      short: HDFS NameNode exporter HTTP port
      port: "{{ exporter_hdfs_nn_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: exporter_hdfs_zkfc_http_port
      short: HDFS ZooKeeper Failover Controller exporter HTTP port
      port: "{{ exporter_hdfs_zkfc_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
  hdfs_dn:
    - name: hdfs_dn_data_port
      short: HDFS DataNode data transfer port
      port: "{{ hdfs_dn_data_port }}"
      protocol: tcp
      zones:
        - internal
      state: present
    - name: hdfs_dn_ipc_port
      short: HDFS DataNode metadata port
      port: "{{ hdfs_dn_ipc_port }}"
      protocol: tcp
      zones:
        - internal
      state: present
    # Public ports
    - name: hdfs_dn_https_port
      short: HDFS DataNode HTTPS port
      port: "{{ hdfs_dn_https_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_hdfs_dn_http_port
      short: HDFS DataNode exporter HTTP port
      port: "{{ exporter_hdfs_dn_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
  hdfs_jn:
    - name: hdfs_jn_rpc_port
      short: HDFS JournalNode RPC port
      port: "{{ hdfs_jn_rpc_port }}"
      protocol: tcp
      zones:
        - internal
      state: present
    - name: hdfs_jn_https_port
      short: HDFS JournalNode HTTPS port
      port: "{{ hdfs_jn_https_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_hdfs_jn_http_port
      short: HDFS JournalNode exporter HTTP port
      port: "{{ exporter_hdfs_jn_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present

  # YARN
  yarn_rm:
    - name: yarn_rm_scheduler_port
      short: YARN ResourceManager scheduler port
      port: "{{ yarn_rm_scheduler_port }}"
      protocol: tcp
      zones:
        - internal
      state: present
    - name: yarn_rm_tracker_port
      short: YARN ResourceManager resource tracker port
      port: "{{ yarn_rm_tracker_port }}"
      protocol: tcp
      zones:
        - internal
      state: present
    - name: yarn_rm_jobs_port
      short: YARN ResourceManager jobs submission port
      port: "{{ yarn_rm_jobs_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: yarn_rm_admin_port
      short: YARN ResourceManager admin port
      port: "{{ yarn_rm_admin_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: yarn_rm_https_port
      short: YARN ResourceManager HTTPS port
      port: "{{ yarn_rm_https_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_yarn_rm_http_port
      short: YARN ResourceManager exporter HTTP port
      port: "{{ exporter_yarn_rm_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
  yarn_nm:
    - name: yarn_nm_rpc_port
      short: YARN NodeManager RPC port
      port: "{{ yarn_nm_rpc_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: yarn_nm_localizer_port
      short: YARN NodeManager localizer port
      port: "{{ yarn_nm_localizer_port }}"
      protocol: tcp
      zones:
        - internal
      state: present
    - name: yarn_nm_https_port
      short: YARN NodeManager HTTPS port
      port: "{{ yarn_nm_https_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: mapred_sh_shuffle_port
      short: MapReduce ShuffleHandler shuffle port
      port: "{{ mapred_sh_shuffle_port }}"
      protocol: tcp
      zones:
        - internal
      state: present
    # YARN MapReduce apps
    - name: mapred_am_bind_portrange
      short: MapReduce ApplicationMaster bind port range
      port: "{{ mapred_am_bind_portrange }}"
      protocol: tcp
      zones:
        - internal
      state: present
    # YARN Tez apps
    - name: tez_am_task_portrange
      short: Tez ApplicationMaster task bind port range
      port: "{{ tez_am_task_portrange }}"
      protocol: tcp
      zones:
        - internal
      state: present
    - name: tez_am_client_portrange
      short: Tez ApplicationMaster client bind port range
      port: "{{ tez_am_client_portrange }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # YARN Spark apps
    - name: spark_shuffle_service_port
      short: Spark external shuffle service port
      port: "{{ spark_shuffle_service_port }}"
      protocol: tcp
      zones:
        - internal
      state: present
    - name: spark_driver_bind_portrange
      short: Spark driver service port range
      port: "{{ spark_driver_bind_port }}-{{ spark_driver_bind_port + spark_port_max_retries }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: spark_blockmanager_bind_portrange
      short: Spark block manager service port range
      port: "{{ spark_blockmanager_bind_port }}-{{ spark_blockmanager_bind_port + spark_port_max_retries }}"
      protocol: tcp
      zones:
        - internal
      state: present
    - name: spark_ui_bind_portrange
      short: Spark UI bind port range
      port: "{{ spark_ui_bind_port }}-{{ spark_ui_bind_port + spark_port_max_retries }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # YARN Spark3 apps
    - name: spark3_shuffle_service_port
      short: Spark3 external shuffle service port
      port: "{{ spark3_shuffle_service_port }}"
      protocol: tcp
      zones:
        - internal
      state: present
    - name: spark3_driver_bind_portrange
      short: Spark3 driver service port range
      port: "{{ spark3_driver_bind_port }}-{{ spark3_driver_bind_port + spark3_port_max_retries }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: spark3_blockmanager_bind_portrange
      short: Spark3 block manager service port range
      port: "{{ spark3_blockmanager_bind_port }}-{{ spark3_blockmanager_bind_port + spark3_port_max_retries }}"
      protocol: tcp
      zones:
        - internal
      state: present
    - name: spark3_ui_bind_portrange
      short: Spark3 UI bind port range
      port: "{{ spark3_ui_bind_port }}-{{ spark3_ui_bind_port + spark3_port_max_retries }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_yarn_nm_http_port
      short: YARN NodeManager exporter HTTP port
      port: "{{ exporter_yarn_nm_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
  yarn_ats:
    - name: yarn_ats_rpc_port
      short: YARN AppTimelineServer RPC port
      port: "{{ yarn_ats_rpc_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: yarn_ats_https_port
      short: YARN AppTimelineServer HTTPS port
      port: "{{ yarn_ats_https_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_yarn_ats_http_port
      short: YARN AppTimelineServer exporter HTTP port
      port: "{{ exporter_yarn_ats_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present

  # MapReduce
  mapred_jhs:
    - name: mapred_jhs_rpc_port
      short: MapReduce JobHistoryServer RPC port
      port: "{{ mapred_jhs_rpc_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: mapred_jhs_admin_port
      short: MapReduce JobHistoryServer admin port
      port: "{{ mapred_jhs_admin_port }}"
      protocol: tcp
      zones:
        - internal
      state: present
    - name: mapred_jhs_https_port
      short: MapReduce JobHistoryServer HTTPS port
      port: "{{ mapred_jhs_https_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_mapred_jhs_http_port
      short: MapReduce JobHistoryServer exporter HTTP port
      port: "{{ exporter_mapred_jhs_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present

  # Hive
  hive_s2:
    - name: hive_hiveserver2_thrift_port
      short: Hive Server2 Thrift binary port
      port: "{{ hive_hiveserver2_thrift_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: hive_hiveserver2_thrift_http_port
      short: Hive Server2 Thrift HTTP port
      port: "{{ hive_hiveserver2_thrift_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: hive_hiveserver2_webui_port
      short: Hive Server2 web UI port
      port: "{{ hive_hiveserver2_webui_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: "{% if hive_hiveserver2_webui_port > 0 %}present{% else %}absent{% endif %}"
    # Prometheus exporter
    - name: exporter_hive_hs2_http_port
      short: Hive Server2 exporter HTTP port
      port: "{{ exporter_hive_hs2_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
  hive_ms:
    - name: hive_metastore_listener_port
      short: Hive Metastore listener port
      port: "{{ hive_metastore_listener_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_hive_hms_http_port
      short: Hive Metastore exporter HTTP port
      port: "{{ exporter_hive_hms_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present

  # HBase
  hbase_master:
    - name: hbase_master_rpc_port
      short: HBase Master RPC port
      port: "{{ hbase_master_rpc_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: hbase_master_info_port
      short: HBase Master info port
      port: "{{ hbase_master_info_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_hbase_hm_http_port
      short: HBase Master exporter HTTP port
      port: "{{ exporter_hbase_hm_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
  hbase_rs:
    - name: hbase_rs_rpc_port
      short: HBase RegionServer RPC port
      port: "{{ hbase_rs_rpc_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: hbase_rs_info_port
      short: HBase RegionServer info port
      port: "{{ hbase_rs_info_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_hbase_hrs_http_port
      short: HBase RegionServer exporter HTTP port
      port: "{{ exporter_hbase_hrs_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
  hbase_rest:
    - name: hbase_rest_client_port
      short: HBase REST client port
      port: "{{ hbase_rest_client_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: hbase_rest_info_port
      short: HBase REST info port
      port: "{{ hbase_rest_info_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_hbase_hr_http_port
      short: HBase RegionServer exporter HTTP port
      port: "{{ exporter_hbase_hr_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present

  # Phoenix
  phoenix_queryserver_daemon:
    - name: phoenix_queryserver_http_port
      short: Phoenix QueryServer listen port
      port: "{{ phoenix_queryserver_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_hbase_pqs_http_port
      short: Phoenix QueryServer exporter HTTP port
      port: "{{ exporter_hbase_pqs_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present

  # Spark
  spark_hs:
    - name: spark_hs_http_port
      short: Spark History Server HTTP port
      port: "{{ spark_hs_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: spark_hs_https_port
      short: Spark History Server HTTPS port
      port: "{{ spark_hs_https_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_spark_hs_http_port
      short: Spark History Server exporter HTTP port
      port: "{{ exporter_spark_hs_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
  spark3_hs:
    - name: spark3_hs_http_port
      short: Spark3 History Server HTTP port
      port: "{{ spark3_hs_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    - name: spark3_hs_https_port
      short: Spark3 History Server HTTPS port
      port: "{{ spark3_hs_https_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_spark3_hs_http_port
      short: Spark3 History Server exporter HTTP port
      port: "{{ exporter_spark3_hs_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present

  # Knox
  knox:
    - name: knox_gateway_port
      short: Knox Gateway port
      port: "{{ knox_gateway_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
    # Prometheus exporter
    - name: exporter_knox_gateway_http_port
      short: Knox Gateway exporter HTTP port
      port: "{{ exporter_knox_gateway_http_port }}"
      protocol: tcp
      zones:
        - internal
        - public
      state: present
