---
- import_role:
    name: tosit.tdp.hadoop.common

- name: Format namenode
  delegate_to: "{{ groups['hdfs_nn'][0] }}"
  run_once: yes
  become: yes
  become_user: "{{ hdfs_user }}"
  command: "{{ hadoop_root_dir }}/hadoop/bin/hdfs --config {{ hadoop_root_conf_dir }}/conf.nn namenode -format"
  args:
    creates: "{{ hdfs_site['dfs.namenode.name.dir'] }}/current"

- name: Start namenode
  delegate_to: "{{ groups['hdfs_nn'][0] }}"
  run_once: yes
  service:
    name: hadoop-hdfs-namenode
    state: started

- name: Bootstrap standby namenode
  delegate_to: "{{ groups['hdfs_nn'][1] }}"
  run_once: yes
  become: yes
  become_user: "{{ hdfs_user }}"
  command: "/opt/tdp/hadoop/bin/hdfs --config /etc/hadoop/conf.nn namenode -bootstrapStandby -nonInteractive"
  args:
    creates: "{{ hdfs_site['dfs.namenode.name.dir'] }}/current"

- name: Set hdfs folder owner
  delegate_to: "{{ groups['hdfs_nn'][1] }}"
  run_once: yes
  file:
    path: "{{ hadoop_hdfs_dir }}"
    owner: "{{ hdfs_user }}"
    group: "{{ hadoop_group }}"
    recurse: yes

- name: Start standby namenode
  delegate_to: "{{ groups['hdfs_nn'][1] }}"
  run_once: yes
  service:
    name: hadoop-hdfs-namenode
    state: started

- name: Start zkfc
  service:
    name: hadoop-hdfs-zkfc
    state: started
