---
- name: Generate principal and keytab for {{ principal }}
  shell: |
    kadmin -r {{ realm }} -p {{ kadmin_principal }} -w {{ kadmin_password }} -q "addprinc -randkey {{ principal }}"
    kadmin -r {{ realm }} -p {{ kadmin_principal }} -w {{ kadmin_password }} -q "xst -k {{ keytab }} {{ principal }}@{{ realm }}"
    chown {{ user }}:{{ group }} {{ keytab }}
    chmod {{ mode }} {{ keytab }} 
  args:
    chdir: "{{ keytabs_dir }}"
    creates: "{{ keytabs_dir }}/{{ keytab }}"
