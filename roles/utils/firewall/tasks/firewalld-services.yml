# Copyright 2022 TOSIT.IO
# SPDX-License-Identifier: Apache-2.0

---
- name: Template firewalld services
  template:
    src: firewalld-service.xml.j2
    dest: "/etc/firewalld/services/{{ name }}.xml"
    lstrip_blocks: yes
  vars:
    name: "{{ component }}_{{ item.key }}"
    short: "{{ item.value.short }}"
    port: "{{ item.value.port }}"
    protocol: "{{ item.value.protocol }}"
  loop: "{{ rules | dict2items }}"
  loop_control:
    label: "{{ component }}_{{ item.key }}"

- name: Add firewalld services to zones
  include_role:
    name: tosit.tdp.utils.firewall
    tasks_from: firewalld-zone-services
  vars:
    zone: "{{ item.value.zone }}"
    services: "{{ [(component + '_' + item.key)] }}"
  when: item.value.enabled
  loop: "{{ rules | dict2items }}"

- name: Reload firewalld
  service:
    name: firewalld
    state: reloaded
  when: firewall_enabled
