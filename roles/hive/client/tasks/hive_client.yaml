---
- import_role:
    name: tosit.tdp.hive.common
    tasks_from: install

- name: Create configuration directory
  file:
    path: '{{ hive_client_conf_dir }}'
    state: directory
    group: '{{ hadoop_group }}'
    owner: '{{ hive_user }}'

- name: Backup configuration
  copy:
    src: '{{ hive_client_conf_dir }}/'
    dest: '{{ hive_client_conf_dir }}.{{ ansible_date_time.epoch }}'
    group: '{{ hadoop_group }}'
    owner: '{{ hive_user }}'
    remote_src: yes
  tags:
    - backup

- name: Template hive-env.sh
  template:
    src: hive-env.sh.j2
    dest: '{{ hive_client_conf_dir }}/hive-env.sh'

- name: Template hive-log4j2.properties
  template:
    src: hive-log4j2.properties.j2
    dest: '{{ hive_client_conf_dir }}/hive-log4j2.properties'

- name: Template hive-site.xml
  template:
    src: hive-site.xml.j2
    dest: '{{ hive_client_conf_dir }}/hive-site.xml'

- name: Convert cert and key to pk12
  shell: |
    openssl pkcs12 \
      -export \
      -in /etc/ssl/certs/{{ ansible_fqdn }}.pem \
      -inkey /etc/ssl/certs/{{ ansible_fqdn }}.key \
      -out /etc/ssl/certs/{{ ansible_fqdn }}.p12 \
      -name {{ ansible_fqdn }} \
      -CAfile /etc/ssl/certs/root.pem \
      -caname root_ca \
      -password pass:{{ hive_keystore_password }}
  args:
    creates: '/etc/ssl/certs/{{ ansible_fqdn }}.p12'

- name: Create keystore and add Certificate Authority into it
  shell: |
    keytool \
      -importkeystore \
      -deststorepass {{ hive_keystore_password }} \
      -destkeypass {{ hive_keystore_password }} \
      -destkeystore {{ hive_keystore_location }} \
      -srckeystore /etc/ssl/certs/{{ ansible_fqdn }}.p12 \
      -srcstoretype PKCS12 \
      -srcstorepass {{ hive_keystore_password }} \
      -alias {{ ansible_fqdn }}

    keytool \
      -keystore {{ hive_keystore_location }} \
      -alias root_ca \
      -import \
      -file /etc/ssl/certs/root.pem \
      -storepass {{ hive_keystore_password }} \
      -noprompt
  args:
    creates: '{{ hive_keystore_location }}'

- name: Create truststore
  shell: |
    keytool \
      -keystore {{ hive_truststore_location }} \
      -deststorepass {{ hive_truststore_password }} \
      -alias root_ca \
      -import \
      -file /etc/ssl/certs/root.pem \
      -noprompt
  args:
    creates: '{{ hive_truststore_location }}'

- name: Render /usr/bin/hive command
  template:
    src: hive-command.j2
    dest: /usr/bin/hive
    mode: 0755

- name: Render /usr/bin/beeline command
  template:
    src: beeline-command.j2
    dest: /usr/bin/beeline
    mode: 0755

- name: Render /usr/bin/beeline_auto command
  template:
    src: beeline-auto-command.j2
    dest: /usr/bin/beeline_auto
    mode: 0755
