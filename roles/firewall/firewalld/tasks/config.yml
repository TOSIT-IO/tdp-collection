# Copyright 2022 TOSIT.IO
# SPDX-License-Identifier: Apache-2.0

---
- name: Generate host_firewalld_rules var
  set_fact:
    host_firewalld_rules: |
      {{ group_names | intersect(firewalld_rules.keys()) | map('extract', firewalld_rules) | flatten }}

- block:
    - name: Template firewalld ipsets from Ansible groups
      template:
        src: firewalld-ipset.xml.j2
        dest: "/etc/firewalld/ipsets/{{ firewalld_files_prefix }}{{ item }}.xml"
        lstrip_blocks: yes
      vars:
        short: "{{ item }} Ansible group"
        hosts: "{{ groups[item] }}"
      loop: "{{ firewalld_zones | map(attribute='groups') | flatten }}"
      loop_control:
        label: "{{ firewalld_files_prefix }}{{ item }}"
      notify: "Reload firewalld"

    - name: Template firewalld services
      template:
        src: firewalld-service.xml.j2
        dest: "/etc/firewalld/services/{{ firewalld_files_prefix }}{{ item.name }}.xml"
        lstrip_blocks: yes
      vars:
        short: "{{ item.short }}"
        port: "{{ item.port }}"
        protocol: "{{ item.protocol }}"
      loop: "{{ host_firewalld_rules }}"
      loop_control:
        label: "{{ firewalld_files_prefix }}{{ item.name }}"
      notify: "Reload firewalld"

    - name: Template firewalld zones
      template:
        src: firewalld-zone.xml.j2
        dest: "/etc/firewalld/zones/{{ firewalld_files_prefix }}{{ item.name }}.xml"
        lstrip_blocks: yes
      vars:
        short: "{{ item.short }}"
        ipsets: "{{ item.groups }}"
        addresses: "{{ item.addresses }}"
        services: |
          {{ host_firewalld_rules | json_query("[?contains(zones, '" + item.name + "')]") }}
      loop: "{{ firewalld_zones }}"
      loop_control:
        label: "{{ firewalld_files_prefix }}{{ item.name }}"
      notify: "Reload firewalld"
  when: firewall_tdp_managed

- block:
    - name: Delete all TDP firewalld ipsets
      file:
        path: "/etc/firewalld/ipsets/{{ firewalld_files_prefix }}{{ item }}.xml"
        state: absent
      loop: "{{ firewalld_zones | map(attribute='groups') | flatten }}"
      loop_control:
        label: "/etc/firewalld/ipsets/{{ firewalld_files_prefix }}{{ item }}.xml"

    - name: Delete all TDP firewalld services
      file:
        path: "/etc/firewalld/services/{{ firewalld_files_prefix }}{{ item.name }}.xml"
        state: absent
      loop: "{{ host_firewalld_rules }}"
      loop_control:
        label: "/etc/firewalld/services/{{ firewalld_files_prefix }}{{ item.name }}.xml"

    - name: Delete all TDP firewalld zones
      file:
        path: "/etc/firewalld/zones/{{ firewalld_files_prefix }}{{ item[0].name }}.xml{{ item[1] }}"
        state: absent
      loop: "{{ firewalld_zones | product(['', '.old']) | list }}"
      loop_control:
        label: "/etc/firewalld/zones/{{ firewalld_files_prefix }}{{ item[0].name }}.xml{{ item[1] }}"
  when: not firewall_tdp_managed

- name: Enable firewalld
  service:
    name: firewalld
    enabled: "{{ firewall_start_on_boot }}"
  when: firewall_tdp_managed
