---
- import_role:
    name: tosit.tdp.kerberos.common

- import_role:
    name: tosit.tdp.hadoop.common
    vars_from: defaults/main.yml

- name: Generate principal and keytab for yarn user with run_once
  run_once: yes
  shell: |
    kadmin -r {{ realm }} -p {{ kadmin_principal }} -w {{ kadmin_password }} -q "addprinc -randkey yarn"
    kadmin -r {{ realm }} -p {{ kadmin_principal }} -w {{ kadmin_password }} -q "xst -k yarn.headless.keytab yarn@{{ realm }}"
    chown {{ yarn_user }}:{{ hadoop_group }} yarn.headless.keytab
  args:
    chdir: /etc/security/keytabs
    creates: /etc/security/keytabs/yarn.headless.keytab
  register: keytab_generation

- name: Fetch keytab from remote host
  run_once: yes
  fetch:
    src: /etc/security/keytabs/yarn.headless.keytab
    dest: buffer/yarn.headless.keytab
    flat: yes
  when: keytab_generation.changed

- name: Copy keytab to remote hosts
  copy:
    src: buffer/yarn.headless.keytab
    dest: /etc/security/keytabs/
    owner: "{{ yarn_user }}"
    group: "{{ hadoop_group }}"
    mode: '0600'
  when: keytab_generation.changed

- name: Generate principal and keytab for mapred user with run_once
  run_once: yes
  shell: |
    kadmin -r {{ realm }} -p {{ kadmin_principal }} -w {{ kadmin_password }} -q "addprinc -randkey mapred"
    kadmin -r {{ realm }} -p {{ kadmin_principal }} -w {{ kadmin_password }} -q "xst -k mapred.headless.keytab mapred@{{ realm }}"
    chown {{ mapred_user }}:{{ hadoop_group }} mapred.headless.keytab
  args:
    chdir: /etc/security/keytabs
    creates: /etc/security/keytabs/mapred.headless.keytab
  register: keytab_generation

- name: Fetch keytab from remote host
  run_once: yes
  fetch:
    src: /etc/security/keytabs/mapred.headless.keytab
    dest: buffer/mapred.headless.keytab
    flat: yes
  when: keytab_generation.changed

- name: Copy keytab to remote hosts
  copy:
    src: buffer/mapred.headless.keytab
    dest: /etc/security/keytabs/
    owner: "{{ mapred_user }}"
    group: "{{ hadoop_group }}"
    mode: '0600'
  when: keytab_generation.changed

- local_action: file path=buffer state=absent
  become: no
