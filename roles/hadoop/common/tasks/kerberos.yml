---
- name: Attempt to fetch the http secret key 
  fetch:
    src: /etc/security/http_secret
    dest: /tmp/hadoop_http_secret
    flat: yes
    fail_on_missing: no
  run_once: true
  register: fetch_results

- name: Create the http secret key locally 
  local_action: shell dd if=/dev/urandom of=/tmp/hadoop_http_secret bs=1024 count=1
  run_once: true
  args:
    creates: /tmp/hadoop_http_secret
  when: not fetch_results.changed

- name: Copy the local http secret key to all nodes
  copy:
    src: /tmp/hadoop_http_secret
    dest: /etc/security/http_secret
    force: yes
    owner: hdfs
    group: hadoop
    mode: 0444

- name: Delete the local http secret key
  local_action: file path="/tmp/hadoop_http_secret" state="absent"
  run_once: true
