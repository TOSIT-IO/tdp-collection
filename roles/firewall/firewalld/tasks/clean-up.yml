# Copyright 2022 TOSIT.IO
# SPDX-License-Identifier: Apache-2.0

---
# Remove all firewalld rules generated by TDP
- name: Generate host_firewalld_rules var
  set_fact:
    host_firewalld_rules: |
      {{ group_names | intersect(firewalld_rules.keys()) | map('extract', firewalld_rules) | flatten }}

- name: Delete all TDP firewalld ipsets
  file:
    path: "/etc/firewalld/ipsets/{{ firewalld_files_prefix }}{{ item }}.xml"
    state: absent
  loop: "{{ firewalld_zones | map(attribute='groups') | flatten }}"
  loop_control:
    label: "/etc/firewalld/ipsets/{{ firewalld_files_prefix }}{{ item }}.xml"

- name: Delete all TDP firewalld services
  file:
    path: "/etc/firewalld/services/{{ firewalld_files_prefix }}{{ item.name }}.xml"
    state: absent
  loop: "{{ host_firewalld_rules }}"
  loop_control:
    label: "/etc/firewalld/services/{{ firewalld_files_prefix }}{{ item.name }}.xml"

- name: Delete all TDP firewalld zones
  file:
    path: "/etc/firewalld/zones/{{ firewalld_files_prefix }}{{ item[0].name }}.xml{{ item[1] }}"
    state: absent
  loop: "{{ firewalld_zones | product(['', '.old']) | list }}"
  loop_control:
    label: "/etc/firewalld/zones/{{ firewalld_files_prefix }}{{ item[0].name }}.xml{{ item[1] }}"
