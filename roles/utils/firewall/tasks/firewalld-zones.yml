# Copyright 2022 TOSIT.IO
# SPDX-License-Identifier: Apache-2.0

---
- name: Create firewalld zones
  copy:
    content: |
      <?xml version="1.0" encoding="utf-8"?>
      <zone></zone>
    dest: "/etc/firewalld/zones/{{ item }}.xml"
    force: no
  loop: "{{ zones | map(attribute='name') }}"
  register: firewalld_create_zones

- name: Reload firewalld
  service:
    name: firewalld
    state: reloaded
  when: firewall_enabled

- name: Remove existing sources from firewalld zones
  xml:
    path: "/etc/firewalld/zones/{{ item.name }}.xml"
    xpath: "/zone/source"
    state: absent
    pretty_print: yes
  loop: "{{ zones }}"
  loop_control:
    label: "{{ item.name }}"

- name: Add Ansible groups as ipsets to firewalld zones
  include_role:
    name: tosit.tdp.utils.firewall
    tasks_from: firewalld-zone-sources
  vars:
    zone: "{{ item.name }}"
    type: ipset
    sources: "{{ item.groups }}"
  loop: "{{ zones }}"

- name: Add addresses to firewalld zones
  include_role:
    name: tosit.tdp.utils.firewall
    tasks_from: firewalld-zone-sources
  vars:
    zone: "{{ item.name }}"
    type: address
    sources: "{{ item.addresses }}"
  loop: "{{ zones }}"

- name: Reload firewalld
  service:
    name: firewalld
    state: reloaded
  when: firewall_enabled
